# =============================================================================
# Template Sensors for Propane Calculations
# =============================================================================
- sensor:
# -----------------------------------------------------------------------------
# STANDARD SENSORS (Calculated on State Change)
# -----------------------------------------------------------------------------
    # Gallons Remaining
    - name: "Propane Tank Gallons Remaining"
      unique_id: propane_tank_gallons_remaining
      unit_of_measurement: "gal"
      device_class: volume_storage
      state_class: measurement
      state: >
        {% set capacity = states('sensor.amerigas_tank_size') | float(500) %}
        {% set percent = states('sensor.amerigas_tank_level') | float(0) %}
        {{ (capacity * (percent / 100)) | round(2) }}
      availability: >
        {{ states('sensor.amerigas_tank_size') | is_number and 
           states('sensor.amerigas_tank_level') | is_number }}

    # Propane Used Since Last Delivery (Resets automatically)
    # UPDATED: Added logic to prevent negative numbers during thermal expansion
    - name: "Propane Used Since Last Delivery"
      unique_id: propane_used_since_last_delivery
      unit_of_measurement: "gal"
      state_class: total
      icon: mdi:gas-station
      state: >
        {% set capacity = states('sensor.amerigas_tank_size') | float(500) %}
        {# We assume a "full" tank is 80% of capacity #}
        {% set full_fill_level = capacity * 0.8 %}
        {% set current = states('sensor.propane_tank_gallons_remaining') | float(0) %}
        
        {# Simple subtraction from the theoretical 'full' mark #}
        {% set used = full_fill_level - current %}
        
        {# If used < 0, it means tank is above 80% (overfill or heat), show 0 #}
        {{ used if used > 0 else 0 | round(2) }}
      availability: >
        {{ states('sensor.propane_tank_gallons_remaining') | is_number }}

    # Propane Energy Consumption - Current Period
    # NOTE: Display only. DO NOT use for Energy Dashboard (it resets)
    - name: "Propane Energy Consumption"
      unique_id: propane_energy_consumption
      unit_of_measurement: "ft続"
      device_class: gas
      state_class: total 
      icon: mdi:fire
      state: >
        {% set gallons = states('sensor.propane_used_since_last_delivery') | float(0) %}
        {{ (gallons * 36.3888) | round(2) }}
      availability: >
        {{ states('sensor.propane_used_since_last_delivery') | is_number }}

    # Daily Average Usage
    - name: "Propane Daily Average Usage"
      unique_id: propane_daily_average_usage
      unit_of_measurement: "gal/day"
      state_class: measurement
      icon: mdi:chart-line
      state: >
        {% set last_date = states('sensor.amerigas_last_delivery_date') %}
        {% set used = states('sensor.propane_used_since_last_delivery') | float(0) %}
        
        {% if last_date not in ['unknown', 'unavailable', 'none'] %}
          {% set delivery_dt = as_datetime(last_date) | as_local %}
          {% if delivery_dt is not none %}
            {% set days = (now() - delivery_dt).days %}
            {% if days > 0 %}
              {{ (used / days) | round(2) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}
      availability: >
        {{ states('sensor.amerigas_last_delivery_date') not in ['unknown', 'unavailable', 'none'] }}

    # Days Until Empty
    - name: "Propane Days Until Empty"
      unique_id: propane_days_until_empty
      unit_of_measurement: "days"
      state_class: measurement
      icon: mdi:calendar-clock
      state: >
        {% set remaining = states('sensor.propane_tank_gallons_remaining') | float(0) %}
        {% set avg_usage = states('sensor.propane_daily_average_usage') | float(0) %}
        {% if avg_usage > 0.1 %}
          {{ (remaining / avg_usage) | round(0) }}
        {% else %}
          999
        {% endif %}
      availability: >
        {{ states('sensor.propane_tank_gallons_remaining') | is_number and 
           states('sensor.propane_daily_average_usage') | is_number }}

    # Cost Per Gallon
    - name: "Propane Cost Per Gallon"
      unique_id: propane_cost_per_gallon
      unit_of_measurement: "$/gal"
      state_class: measurement
      icon: mdi:currency-usd
      state: >
        {% set pay = states('sensor.amerigas_last_payment_amount') | float(0) %}
        {% set del = states('sensor.amerigas_last_delivery_gallons') | float(0) %}
        {% if del > 0 %}
          {{ (pay / del) | round(2) }}
        {% else %}
          0
        {% endif %}
      availability: >
        {{ states('sensor.amerigas_last_payment_amount') | is_number and 
           states('sensor.amerigas_last_delivery_gallons') | is_number }}

    # Cost Per Cubic Foot (For Dashboard Pricing)
    - name: "Propane Cost Per Cubic Foot"
      unique_id: propane_cost_per_cubic_foot
      unit_of_measurement: "$/ft続"
      state_class: measurement
      icon: mdi:currency-usd
      state: >
        {% set cost_gal = states('sensor.propane_cost_per_gallon') | float(0) %}
        {% if cost_gal > 0 %}
          {{ (cost_gal / 36.3888) | round(4) }}
        {% else %}
          0
        {% endif %}
      availability: >
        {{ states('sensor.propane_cost_per_gallon') | is_number }}

    # Cost Since Last Delivery
    - name: "Propane Cost Since Last Delivery"
      unique_id: propane_cost_since_last_delivery
      unit_of_measurement: "$"
      device_class: monetary
      state_class: total
      icon: mdi:cash
      state: >
        {% set used = states('sensor.propane_used_since_last_delivery') | float(0) %}
        {% set cost = states('sensor.propane_cost_per_gallon') | float(0) %}
        {{ (used * cost) | round(2) }}
      availability: >
        {{ states('sensor.propane_used_since_last_delivery') | is_number and 
           states('sensor.propane_cost_per_gallon') | is_number }}

    # Estimated Refill Cost
    - name: "Propane Estimated Refill Cost"
      unique_id: propane_estimated_refill_cost
      unit_of_measurement: "$"
      state_class: measurement
      icon: mdi:cash-multiple
      state: >
        {% set capacity = states('sensor.amerigas_tank_size') | float(500) %}
        {% set remaining = states('sensor.propane_tank_gallons_remaining') | float(0) %}
        {% set cost = states('sensor.propane_cost_per_gallon') | float(0) %}
        {% set needed = capacity - remaining %}
        {{ (needed * cost) | round(2) }}
      availability: >
        {{ states('sensor.propane_tank_gallons_remaining') | is_number and 
           states('sensor.propane_cost_per_gallon') | is_number }}

    # Days Since Last Delivery
    - name: "Propane Days Since Last Delivery"
      unique_id: propane_days_since_last_delivery
      unit_of_measurement: "days"
      icon: mdi:calendar
      state: >
        {% set last_date = states('sensor.amerigas_last_delivery_date') %}
        {% if last_date not in ['unknown', 'unavailable', 'none'] %}
          {% set delivery_dt = as_datetime(last_date) | as_local %}
          {% if delivery_dt is not none %}
            {{ (now() - delivery_dt).days }}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}
      availability: >
        {{ states('sensor.amerigas_last_delivery_date') not in ['unknown', 'unavailable', 'none'] }}

    # Comparison vs AmeriGas
    - name: "Propane Days Remaining Difference"
      unique_id: propane_days_remaining_difference
      unit_of_measurement: "days"
      icon: mdi:compare
      state: >
        {% set amerigas = states('sensor.amerigas_days_remaining') | int(0) %}
        {% set mine = states('sensor.propane_days_until_empty') | int(0) %}
        {{ mine - amerigas }}
      attributes:
        amerigas_estimate: "{{ states('sensor.amerigas_days_remaining') }}"
        your_estimate: "{{ states('sensor.propane_days_until_empty') }}"

# -----------------------------------------------------------------------------
# LIFETIME TRACKING SENSORS (The Fixed Logic)
# -----------------------------------------------------------------------------
# UPDATED: Changed from Time Trigger to State Trigger (The "Ratchet").
# This fixes the Energy Dashboard spikes while keeping the original Sensor Name.

- trigger:
    - platform: state
      entity_id: sensor.propane_tank_gallons_remaining
      not_to: 
        - "unknown"
        - "unavailable"
        - "none"
      not_from:
        - "unknown"
        - "unavailable"
        - "none"
  sensor:
    # Lifetime Gallons
    # This sensor creates a permanent running total that only goes UP.
    - name: "Propane Lifetime Gallons"
      unique_id: propane_lifetime_gallons
      unit_of_measurement: "gal"
      state_class: total_increasing
      icon: mdi:gas-station
      state: >
        {% set current_val = trigger.to_state.state | float(0) %}
        {% set previous_val = trigger.from_state.state | float(0) %}
        
        {# Get the previous total, default to 0 if this is the very first run #}
        {% set previous_total = this.state | float(0) %}
        
        {# Calculate the difference in tank level #}
        {% set diff = previous_val - current_val %}

        {# LOGIC: Only add to total if the tank level DROPPED (diff > 0) #}
        {% if diff > 0 %}
          {{ (previous_total + diff) | round(2) }}
        {% else %}
          {# If level went UP (delivery or heat), keep the total exactly the same #}
          {{ previous_total }}
        {% endif %}

    # Lifetime Energy (ft続)
    # This is the PRIMARY sensor for the Energy Dashboard
    - name: "Propane Lifetime Energy"
      unique_id: propane_lifetime_energy
      unit_of_measurement: "ft続"
      device_class: gas
      state_class: total_increasing
      icon: mdi:fire
      state: >
        {% set gallons = states('sensor.propane_lifetime_gallons') | float(0) %}
        {{ (gallons * 36.3888) | round(2) }}
      availability: >
        {{ states('sensor.propane_lifetime_gallons') | is_number }}